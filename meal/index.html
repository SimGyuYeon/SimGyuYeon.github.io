<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>ìš°ë¦¬ì§‘ ì €ë… ë©”ë‰´ ê¸°ë¡</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
      body { font-family: sans-serif; padding: 1rem; margin: 0; background: #f7f7f7; }
      h1 { text-align: center; }
      .container {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      .card {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      }
      .grid-two {
        display: flex;
        gap: 1rem;
      }
      .grid-two > .card {
        flex: 1;
      }
      table { width: 100%; border-collapse: collapse; margin-top: 0.5rem; }
      th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: left; }
      td button { margin-left: 0.25rem; }
      input, button {
        margin: 0.25rem 0;
        padding: 0.5rem;
        font-size: 1rem;
      }

      @media (max-width: 768px) {
        .grid-two {
          flex-direction: column;
        }
      }
    </style>
  </head>
  <body>
    <h1>ğŸ½ï¸ ì €ë… ë©”ë‰´ ê¸°ë¡ ê´€ë¦¬</h1>
    <div class="container">
      <div class="card">
        <h2>ğŸ“… ì‹ë‹¨ ê³„íš</h2>
        <input id="plan-title" placeholder="ê³„íš ë©”ë‰´" />
        <input id="plan-date" type="date" />
        <button onclick="addPlan()">ì¶”ê°€</button>
        <table>
          <thead><tr><th>ì´ë¦„</th><th>ë‚ ì§œ</th><th>ì‘ì—…</th></tr></thead>
          <tbody id="plans-list"></tbody>
        </table>
      </div>
      <div class="grid-two">
        <div class="card">
          <h2>ğŸ¥¬ ëƒ‰ì¥ê³  ì¬ë£Œ</h2>
          <input id="fridge-name" placeholder="ì¬ë£Œëª…" />
          <input id="fridge-qty" type="number" placeholder="ìˆ˜ëŸ‰" />
          <input id="fridge-unit" placeholder="ë‹¨ìœ„" />
          <button onclick="addFridge()">ì¶”ê°€</button>
          <table>
            <thead><tr><th>ì´ë¦„</th><th>ìˆ˜ëŸ‰</th><th>ë‹¨ìœ„</th><th>ì‘ì—…</th></tr></thead>
            <tbody id="fridge-list"></tbody>
          </table>
        </div>
        <div class="card">
          <h2>âœ… ì‹ì‚¬ ê¸°ë¡</h2>
          <input id="meal-title" placeholder="ë©”ë‰´ ì´ë¦„" />
          <input id="meal-date" type="date" />
          <button onclick="addMeal()">ì¶”ê°€</button>
          <table>
            <thead><tr><th>ì´ë¦„</th><th>ë‚ ì§œ</th><th>ì‘ì—…</th></tr></thead>
            <tbody id="meals-list"></tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      const endpoint = 'https://nameless-hat-e0af.sgy311.workers.dev';

      function escapeHtml(str) {
        return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
      }

      function getTitle(item) {
        try {
          if (item.properties?.Title?.title?.length > 0) {
            return item.properties.Title.title[0].plain_text;
          }
          if (item.properties?.ingredient?.title?.length > 0) {
            return item.properties.ingredient.title[0].plain_text;
          }
        } catch (_) {}
        return '(ì œëª© ì—†ìŒ)';
      }

      async function loadData(type) {
        try {
          const res = await fetch(`${endpoint}/${type}`);
          const json = await res.json();
          const listEl = document.getElementById(`${type}-list`) || document.getElementById(`${type}s-list`);
          if (!listEl) {
            console.error(`ëª©ë¡ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${type}-list`);
            return;
          }
          listEl.innerHTML = '';

          json.results.forEach(item => {
            const title = escapeHtml(getTitle(item));
            const date = item.properties?.Date?.date?.start || item.properties?.expiration_date?.date?.start || '';
            const qty = item.properties?.Quantity?.number || '';
            const unit = item.properties?.Unit?.rich_text?.[0]?.text?.content || '';

            const row = document.createElement('tr');
            let html = '';

            if (type === 'meals') {
              html += `<td>${title}</td><td>${date}</td>`;
            } else if (type === 'fridge') {
              html += `<td>${title}</td><td>${qty}</td><td>${unit}</td>`;
            } else if (type === 'plans') {
              html += `<td>${title}</td><td>${date}</td>`;
            }

            html += `<td>
              <button onclick="editItem('${type}', '${item.id}', '${title}')">âœï¸</button>
              <button onclick="deleteItem('${type}', '${item.id}')">âŒ</button>
            </td>`;

            row.innerHTML = html;
            listEl.appendChild(row);
          });
        } catch (err) {
          console.error('ë°ì´í„° ë¡œë”© ì˜¤ë¥˜:', err);
        }
      }

      async function addMeal() {
        const title = document.getElementById('meal-title').value;
        const date = document.getElementById('meal-date').value;
        await axios.post(`${endpoint}/meals`, { title, date });
        loadData('meals');
      }

      async function addFridge() {
        const name = document.getElementById('fridge-name').value;
        const quantity = Number(document.getElementById('fridge-qty').value);
        const unit = document.getElementById('fridge-unit').value;
        await axios.post(`${endpoint}/fridge`, { name, quantity, unit });
        loadData('fridge');
      }

      async function addPlan() {
        const title = document.getElementById('plan-title').value;
        const date = document.getElementById('plan-date').value;
        await axios.post(`${endpoint}/plans`, { title, date });
        loadData('plans');
      }

      async function editItem(type, id, oldTitle) {
        const newTitle = prompt('ìƒˆ ì´ë¦„ìœ¼ë¡œ ìˆ˜ì •:', oldTitle);
        if (!newTitle) return;
        await axios.patch(`${endpoint}/${type}/${id}`, { title: newTitle });
        loadData(type);
      }

      async function deleteItem(type, id) {
        if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        await axios.patch(`${endpoint}/${type}/${id}`, { archive: true });
        loadData(type);
      }

      loadData('meals');
      loadData('fridge');
      loadData('plans');
    </script>
  </body>
</html>
